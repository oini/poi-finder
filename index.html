<!DOCTYPE html>
<html>

<head>
    <meta charset=utf-8 />
    <title>Directions and POI Buffer</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.mapbox.com/mapbox.js/v2.2.3/mapbox.js'></script>
    <script src='https://api.tiles.mapbox.com/mapbox.js/v2.1.5/mapbox.js'></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="//api.tiles.mapbox.com/mapbox.js/plugins/turf/v2.0.0/turf.min.js"></script>
    <script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.4/underscore-min.js"></script>
    <link href='https://api.mapbox.com/mapbox.js/v2.2.3/mapbox.css' rel='stylesheet' />
    <style>
        body {
            margin: 0;
            padding: 0;
        }
        
        #map {
            position: fixed;
            top: 0;
            bottom: 0;
            width: 100%;
            z-index: 0;
        }
    </style>
</head>

<body>

    <div id='map'></div>
    <div id='inputs'></div>
    <div id='errors'></div>
    <div id='directions'>
        <div id='routes'></div>
        <div id='instructions'></div>
    </div>

    <script>

        L.mapbox.accessToken = 'pk.eyJ1Ijoic3JpdmlkeWEiLCJhIjoicXo2NTJKayJ9.m1P57SCwkp8_7N3TgYsVRg';
        var map = L.mapbox.map('map', 'ruthmaben.de10a8ca')
            //    .addControl(L.mapbox.geocoderControl('mapbox.places'));
            .setView([12.9861, 77.5930], 13).addControl(L.mapbox.geocoderControl('mapbox.places'));

        map.on('click', function (e) {
            makeMarker(e, drawRoute);
        });
        var features = [];
        var layerList = [];
        var overlays = {};
        var waypoints = [];
        var polyline = L.polyline([]).addTo(map);
        var worshipmarkercolor = '#' + Math.floor(Math.random()*16777215).toString(16)+'';
        var postofficemarkercolor = '#' + Math.floor(Math.random()*16777215).toString(16)+'';
        var pubmarkercolor = '#' + Math.floor(Math.random()*16777215).toString(16)+'';
        var barmarkercolor = '#' + Math.floor(Math.random()*16777215).toString(16)+'';
        var restaurantmarkercolor = '#' + Math.floor(Math.random()*16777215).toString(16)+'';
        var fastfoodmarkercolor = '#' + Math.floor(Math.random()*16777215).toString(16)+'';
        var cafemarkercolor = '#' + Math.floor(Math.random()*16777215).toString(16)+'';
        var atmmarkercolor = '#' + Math.floor(Math.random()*16777215).toString(16)+'';
        var bankmarkercolor = '#' + Math.floor(Math.random()*16777215).toString(16)+'';
        var kindergartenmarkercolor = '#' + Math.floor(Math.random()*16777215).toString(16)+'';
        var schoolmarkercolor = '#' + Math.floor(Math.random()*16777215).toString(16)+'';
        var collegemarkercolor = '#' + Math.floor(Math.random()*16777215).toString(16)+'';
        var universitymarkercolor = '#' + Math.floor(Math.random()*16777215).toString(16)+'';
        var hospitalmarkercolor = '#' + Math.floor(Math.random()*16777215).toString(16)+'';
        var clinicmarkercolor = '#' + Math.floor(Math.random()*16777215).toString(16)+'';
        var fuelmarkercolor = '#' + Math.floor(Math.random()*16777215).toString(16)+'';
        var policemarkercolor = '#' + Math.floor(Math.random()*16777215).toString(16)+'';
        var toiletsmarkercolor = '#' + Math.floor(Math.random()*16777215).toString(16)+'';
        var librarymarkercolor = '#' + Math.floor(Math.random()*16777215).toString(16)+'';
        var pharmacymarkercolor = '#' + Math.floor(Math.random()*16777215).toString(16)+'';
        var dentistmarkercolor = '#' + Math.floor(Math.random()*16777215).toString(16)+'';
        var cinemamarkercolor = '#' + Math.floor(Math.random()*16777215).toString(16)+'';
        var theatremarkercolor = '#' + Math.floor(Math.random()*16777215).toString(16)+'';
        var parkingmarkercolor = '#' + Math.floor(Math.random()*16777215).toString(16)+'';
        var telephonemarkercolor = '#' + Math.floor(Math.random()*16777215).toString(16)+'';
        var embassymarkercolor = '#' + Math.floor(Math.random()*16777215).toString(16)+'';


        function makeMarker(e, done) {
            var marker = L.marker(e.latlng, {
                draggable: true
            }).addTo(map);
            marker.on('dragend', drawRoute);
            waypoints.push(marker);
            return done();
        }
        var routeLayer = L.mapbox.featureLayer().addTo(map);
        
        var layerControl = L.control.layers({}, {}).addTo(map);

        function drawRoute() {
            if (waypoints.length < 2) {
                var point = waypoints[0]._latlng;
                var geojson = {
                    'type': 'Feature',
                    'geometry': {
                        'type': 'Point',
                        'coordinates': [point.lng, point.lat]
                    },
                    'properties': {
                        'name': 'First Point'
                    }
                }
                routeLayer.setGeoJSON(geojson);
                calculateBuffer(1000);
            }
            // Directions API request looks like
            // http://api.tiles.mapbox.com/v4/directions/mapbox.driving/
            //    latlong.json?access_token={access_token}
            else {
                var points = waypoints.map(function (marker) {
                    var latlng = marker._latlng;
                    return [latlng.lng, latlng.lat].join(',');
                }).join(';');

                var directionsUrl = 'https://api.tiles.mapbox.com/v4/directions/mapbox.driving/' +
                    points + '.json?access_token=' + L.mapbox.accessToken;

                $.get(directionsUrl, function (data) {
                    routeLayer.setGeoJSON(data.routes[0].geometry);
                    routeLayer.setStyle({
                        color: 'black'
                    });
                    calculateBuffer(1000);
                });
            }
        }

        function calculateBuffer(radius) {
            var routes = turf.featurecollection(routeLayer.getLayers().map(function (f) {
                return f.toGeoJSON();
            }));
            var buffer = turf.buffer(routes, radius, 'meters');
            routeLayer.setGeoJSON(buffer);
            routeLayer
                .setGeoJSON(buffer)
                .setStyle({
                    stroke: true,
                    color: "#B2B2B2",
                    fillColor: '#400000',
                    fillOpacity: 0.4
                })
            map.fitBounds(routeLayer.getBounds());
            getPOI(buffer);
        }

        function getPOI(buffer) {
            var bbox = routeLayer.getBounds().toBBoxString().split(',');
            var overpassBbox = bbox[1] + ',' + bbox[0] + ',' + bbox[3] + ',' + bbox[2];
            //return overpassBbox;
            console.log(overpassBbox);
            var amenity_url = "http://www.overpass-api.de/api/interpreter?data=[out:json];node['amenity'](" + overpassBbox + ");out;";
            var tourism_url = "http://www.overpass-api.de/api/interpreter?data=[out:json];node['tourism'='attraction'](" + overpassBbox + ");out;";
            var sports_url = "http://www.overpass-api.de/api/interpreter?data=[out:json];node['leisure'='sports_centre'](" + overpassBbox + ");out;";

            $.ajax(amenity_url)
                .done(function (data) {
                    var pointsGeoJSON = overpassToGeoJSON(data);
                    var within = turf.within(pointsGeoJSON, buffer);
                    console.log(within.features);
                    for (var i = 0; i < within.features.length; i++) {
                        features.push(within.features[i]);
                    }
                    var groupData = _.groupBy(features, function(feature) {
                        return feature.properties.amenity;
                        console.log(feature.properties.amenity);
                    });

                    for (var i=0; i<layerList.length; i++) {
                        layerControl.removeLayer(layerList[i]);
                    }
                    layerList = [];

                    for (var key in groupData) {
                        console.log(groupData[key]);


                        var geojson = {
                            'type': 'FeatureCollection',
                            'features': groupData[key]

                        }
                        var overlayer = L.mapbox.featureLayer().setGeoJSON(geojson);
                        layerList.push(overlayer);
                        layerControl.addOverlay(overlayer, key);
                    }
                })
                .fail(function (err) {
                    alert("overpass query failed!");
                });

            $.ajax(sports_url)
                .done(function (data) {
                    var pointsGeoJSON = overpassToGeoJSON(data);
                    var within = turf.within(pointsGeoJSON, buffer);
                    console.log(within.features);
                    for (var i = 0; i < within.features.length; i++) {
                        features.push(within.features[i]);
                    }
                    var groupData = _.groupBy(features, function(feature) {
                        return feature.properties.amenity;
                    });
                    
                    for (var i=0; i<layerList.length; i++) {
                        layerControl.removeLayer(layerList[i]);
                    }
                    layerList = [];

                    for (var key in groupData) {
                        var geojson = {
                            'type': 'FeatureCollection',
                            'features': groupData[key]
                        }
                        var overlayer = L.mapbox.featureLayer().setGeoJSON(geojson);
                        layerList.push(overlayer);
                        layerControl.addOverlay(overlayer, key);
                    }
                })
                .fail(function (err) {
                    alert("overpass query failed!");
                });

            $.ajax(tourism_url)
                .done(function (data) {
                    var pointsGeoJSON = overpassToGeoJSON(data);
                    var within = turf.within(pointsGeoJSON, buffer);
                    for (var i = 0; i < within.features.length; i++) {
                        features.push(within.features[i]);
                    }
                    var groupData = _.groupBy(features, function(feature) {
                        return feature.properties.amenity;
                    });
                    
                    for (var i=0; i<layerList.length; i++) {
                        layerControl.removeLayer(layerList[i]);
                    }
                    layerList = [];

                    for (var key in groupData) {
                        var geojson = {
                            'type': 'FeatureCollection',
                            'features': groupData[key]
                        }
                        var overlayer = L.mapbox.featureLayer().setGeoJSON(geojson);
                        layerList.push(overlayer);
                        layerControl.addOverlay(overlayer, key);
                    }
                })
                .fail(function (err) {
                    alert("overpass query failed!");
                });
        }

        function overpassToGeoJSON(data) {
             
           
           
            var pointsGeoJSON = {
                'type': 'FeatureCollection',
                'features': []
            };
            for (var i = 0; i <= data.elements.length; i++) {
                var point = data.elements[i];
                if (point && point.lat && point.lon) {
                    var props = point.tags;
                    props.title = point.tags.name;
                   
                    props['marker-size'] = 'medium';
                    props['marker-symbol'] = 'circle';
                    var amenity_marker_list = ['bar', 'school', 'fuel', 'hospital', 'police', 'cafe', 'restaurant', 'bank', 'college', 'toilets', 'library', 'pharmacy', 'dentist', 'cinema', 'theatre', 'parking', 'telephone', 'embassy']
                    if (point.tags.amenity) {
                        if (amenity_marker_list.indexOf(point.tags.amenity) > -1) {
                            props['marker-symbol'] = point.tags.amenity;
                            console.log(point.tags.amenity);

                            if (point.tags.amenity == 'bar') {
                             props['marker-color'] = barmarkercolor;
                            }
                            if (point.tags.amenity == 'school') {
                             props['marker-color'] = schoolmarkercolor;
                            }
                            if (point.tags.amenity == 'fuel') {
                             props['marker-color'] = fuelmarkercolor;
                            }
                            if (point.tags.amenity == 'hospital') {
                             props['marker-color'] = hospitalmarkercolor;
                            }
                            if (point.tags.amenity == 'police') {
                             props['marker-color'] = policemarkercolor;
                            }
                            if (point.tags.amenity == 'cafe') {
                             props['marker-color'] = cafemarkercolor;
                            }
                            if (point.tags.amenity == 'restaurant') {
                             props['marker-color'] = restaurantmarkercolor;
                            }
                            if (point.tags.amenity == 'bank') {
                             props['marker-color'] = bankmarkercolor;
                            }
                            if (point.tags.amenity == 'college') {
                             props['marker-color'] = collegemarkercolor;
                            }
                            if (point.tags.amenity == 'toilets') {
                             props['marker-color'] = toiletsmarkercolor;
                            }
                            if (point.tags.amenity == 'library') {
                             props['marker-color'] = librarymarkercolor;
                            }
                            if (point.tags.amenity == 'pharmacy') {
                             props['marker-color'] = pharmacymarkercolor;
                            }
                            if (point.tags.amenity == 'dentist') {
                             props['marker-color'] = dentistmarkercolor;
                            }
                            if (point.tags.amenity == 'cinema') {
                             props['marker-color'] = cinemamarkercolor;
                            }
                            if (point.tags.amenity == 'theatre') {
                             props['marker-color'] = theatremarkercolor;
                            }
                            if (point.tags.amenity == 'parking') {
                             props['marker-color'] = parkingmarkercolor;
                            }
                            if (point.tags.amenity == 'telephone') {
                             props['marker-color'] = telephonemarkercolor;
                            }
                            if (point.tags.amenity == 'embassy') {
                             props['marker-color'] = embassymarkercolor;
                            }

                            
                        }
                        if (point.tags.amenity == 'place_of_worship') {
                            props['marker-symbol'] = 'place-of-worship';
                             props['marker-color'] = worshipmarkercolor;
                        }
                        if (point.tags.amenity == 'post_office') {
                            props['marker-symbol'] = 'post';
                             props['marker-color'] = postofficemarkercolor;
                        }
                        if (point.tags.amenity == 'pub') {
                            props['marker-symbol'] = 'bar';
                             props['marker-color'] = pubmarkercolor;
                        }
                        if (point.tags.amenity == 'fast_food') {
                            props['marker-symbol'] = 'restaurant';
                            props['marker-color'] = fastfoodmarkercolor;
                            point.tags.amenity = 'restaurant';
                        }
                        if (point.tags.amenity == 'atm') {
                            props['marker-symbol'] = 'bank';
                            props['marker-color'] = atmmarkercolor;
                        }
                        if (point.tags.amenity == 'kindergarten') {
                            props['marker-symbol'] = 'school';
                            props['marker-color'] = kindergartenmarkercolor;
                        }
                        if (point.tags.amenity == 'clinic') {
                            props['marker-symbol'] = 'hospital';
                            point.tags.amenity = 'hospital';
                            props['marker-color'] =clinicmarkercolor;
                        }
                        if (point.tags.amenity == 'university') {
                            props['marker-symbol'] = 'college';
                            props['marker-color'] = universitymarkercolor;
                            point.tags.amenity = 'college';
                        }
                    }
                    if (point.tags.tourism) {
                        props['marker-symbol'] = 'star';
                        props['amenity'] = 'tourism';
                    }
                    if (point.tags.leisure) {
                        props['marker-symbol'] = 'pitch';
                        props['amenity'] = 'sports-centre';
                    }
                        
                    //$.ajax("http://a.tiles.mapbox.com/v4/marker/pin-m-"+point.tags.amenity+"+CCCC00.png?access_token=pk.eyJ1Ijoic3JpdmlkeWEiLCJhIjoicXo2NTJKayJ9.m1P57SCwkp8_7N3TgYsVRg")
                        //.done(function (data) {
                            //props['marker-symbol'] = point.tags.amenity;
                        //})
                        //.fail(function (err) {
                            //props['marker-symbol'] = 'star';
                        //});

                    var geojson = {
                        'type': 'Feature',
                        "properties": props,
                        'geometry': {
                            'type': 'Point',
                            'coordinates': [point.lon, point.lat]
                        }
                    };
                    pointsGeoJSON.features.push(geojson);
                }
            }
            return pointsGeoJSON;
        }

    </script>

</body>

</html>